{% extends 'base.html' %}

{% block content %}
<div class="profile-container">
  <div class="content-area">
    <!-- ===== Header ===================================================== -->
    <div id="personal-info" class="content-section active">
      <h2 class="fw-bold mb-4" style="font-size:2rem; text-align:left;">
        Account Details: {{ user.username }}
      </h2>

      <!-- ===== Grid: Left (Avatar + Info + Projects) | Right (Skills) === -->
      <div class="account-grid" id="account-details">
        <!-- Avatar -->
        <div class="avatar-block">
          <img
            src="{{ user.avatar_presigned or url_for('static', filename='test_avatar.png') }}"
            class="avatar"
            alt="Profile avatar">
        </div>

        <!-- Info card + Participated Projects -->
        <div class="info-view">
          <h3 class="mb-2">Profile Description</h3>
          <p class="profile-description" style="white-space:pre-line;">
            {{ user.bio or 'No description yet.' }}
          </p>

          <p><strong>Username:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Contact Info:</strong> {{ user.contact_info or 'Not provided' }}</p>

          {% if is_owner %}
            <button type="button" class="btn btn-primary" onclick="toggleEditMode()">
              Edit Profile
            </button>
          {% endif %}

          <hr class="my-3">
        </div>

          <!-- ===== Participated Projects ================================= -->
          <section id="participated-projects" class="demos-section">
            <h2 class="section-title">Participated Projects</h2>

            <div class="demo-grid">
              {% if participated_projects %}
                {% for p in participated_projects %}
                  <article class="demo-card" data-project-id="{{ p.id }}">
                    <!-- Project name -->
                    <a class="demo-title"
                       href="{{ url_for('project.project_gui', project_id=p.id) }}">
                      {{ p.name }}
                    </a>

                    <!-- Short description -->
                    {% if p.description %}
                      <p class="demo-desc">
                        {{ p.description[:150] }}{% if p.description|length > 150 %}…{% endif %}
                      </p>
                    {% else %}
                      <p class="demo-desc text-muted">No description provided.</p>
                    {% endif %}

                    <!-- Meta info -->
                    <p class="demo-meta text-muted">
                      Sector: {{ p.sector }} · Team size: {{ p.people_count }}
                    </p>

                    {% if p.skills %}
                      <span class="demo-badge">
                        Skills: {{ p.skills }}
                      </span>
                    {% endif %}
                  </article>
                {% endfor %}
              {% else %}
                <p class="text-muted">No projects yet.</p>
              {% endif %}
            </div>
          </section>
        

       <!-- ===== Skills (bottom right) =================================== -->
    <section id="skills" class="skills-section">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="skills-title">Skills</h2>

        {% if is_owner %}
        <button type="button"
                id="toggle-skill-form"
                class="btn btn-sm btn-outline-primary">
          + Add Skill
        </button>
        {% endif %}
      </div>

      {% if is_owner %}
      <!-- Hidden Add Skill Form -->
      <form id="skill-form"
            class="skill-form mt-3"
            method="POST"
            action="{{ url_for('profile.add_skill') }}"
            style="display:none"
            autocomplete="off">
        <div class="d-flex flex-wrap gap-2">
          
          <select name="instrument" class="form-select" required>
            <option value="" disabled selected>Choose skill</option>

            <!-- Programming Languages -->
            <option value="Python">Python</option>
            <option value="C">C</option>
            <option value="C++">C++</option>
            <option value="JavaScript">JavaScript</option>
            <option value="TypeScript">TypeScript</option>
            <option value="Julia">Julia</option>
            <option value="Rust">Rust</option>
            <option value="Go">Go</option>
            <option value="Java">Java</option>

            <!-- Web Development -->
            <option value="HTML">HTML</option>
            <option value="CSS">CSS</option>
            <option value="Flask">Flask</option>
            <option value="React">React</option>
            <option value="Node.js">Node.js</option>

            <!-- Data & ML -->
            <option value="NumPy">NumPy</option>
            <option value="pandas">pandas</option>
            <option value="PyTorch">PyTorch</option>
            <option value="TensorFlow">TensorFlow</option>
            <option value="SQL">SQL</option>

            <!-- DevOps & Tools -->
            <option value="Git">Git</option>
            <option value="Docker">Docker</option>
            <option value="Linux">Linux</option>
            <option value="AWS">AWS</option>
          </select>

          <select name="level" class="form-select" required>
            <option value="" disabled selected>Experience level</option>
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Advanced</option>
            <option>Expert</option>
          </select>

          <div>
            <label class="years-label small text-muted">Years:</label>
            <input type="number"
                  name="years"
                  min="0"
                  max="50"
                  step="1"
                  class="form-control"
                  value="1"
                  required>
          </div>

          <button type="submit" class="btn btn-success">
            Save Skill
          </button>

        </div>
      </form>
      {% endif %}

      <!-- Skill List -->
      <ul id="skills-list" class="skills-list mt-3">
        {% for us in user.skills %}
          <li class="skill-item">
            <div class="skill-row">
              <span class="skill-name">{{ us.skill.name }}</span>
              {% if is_owner %}
              <form method="POST"
                    action="{{ url_for('profile.delete_skill', user_skill_id=us.id) }}">
                <button type="submit" class="skill-remove">×</button>
              </form>
              {% endif %}
            </div>
            <div class="skill-meta">{{ us.level }} • {{ us.years }} years</div>
            <div class="skill-bar">
              <span style="--w:{% if us.level == 'Beginner' %}25%{% elif us.level == 'Intermediate' %}50%{% elif us.level == 'Advanced' %}75%{% else %}100%{% endif %}"></span>
            </div>
          </li>
        {% else %}
          <p class="text-muted">No skills added yet.</p>
        {% endfor %}
      </ul>
    </section>

    <!-- ===== Edit Mode (hidden overlay block) =========================== -->
    <div class="info-edit" id="info-edit" style="display:none;">
      <!-- Avatar upload -->
      <form method="POST"
            action="{{ url_for('profile.upload_avatar') }}"
            enctype="multipart/form-data"
            class="mt-3">
        <div class="form-group">
          <label for="avatar_file">Upload avatar image</label>
          <input type="file"
                 id="avatar_file"
                 name="avatar_file"
                 class="form-control"
                 accept="image/*">
        </div>
        <button type="submit" class="btn btn-primary mt-2">
          Upload to S3
        </button>
      </form>

      <!-- Profile update -->
      <form method="POST"
            action="{{ url_for('profile.update_profile') }}"
            class="mt-4">
        <div class="form-group mb-2">
          <label for="username">Username</label>
          <input type="text"
                 class="form-control"
                 id="username"
                 name="username"
                 value="{{ user.username }}">
        </div>

        <div class="form-group mb-2">
          <label for="email">Email</label>
          <input type="email"
                 class="form-control"
                 id="email"
                 name="email"
                 value="{{ user.email }}">
        </div>

        <div class="form-group mb-2">
          <label for="contact_info">Contact Info</label>
          <input type="text"
                 class="form-control"
                 id="contact_info"
                 name="contact_info"
                 value="{{ user.contact_info }}">
        </div>

        <div class="form-group mb-3">
          <label for="bio">Profile Description</label>
          <textarea class="form-control"
                    id="bio"
                    name="bio"
                    rows="4"
                    placeholder="Tell others about yourself...">{{ user.bio or '' }}</textarea>
        </div>

        <div class="form-buttons" style="display:flex; gap:.5rem;">
          <button type="submit" class="btn btn-success">
            Save Changes
          </button>
          <button type="button"
                  class="btn btn-secondary"
                  onclick="toggleEditMode()">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <!-- ===== Created / Active / Favorite projects ======================= -->
    <div id="created-projects" class="content-section">
      <h3>Created Projects</h3>
      <div class="projects-grid">
        {% if user.projects %}
          {% for project in user.projects %}
            {% with is_creator=True %}
              {% include 'project_card.html' %}
            {% endwith %}
          {% endfor %}
        {% else %}
          <p>No projects created yet.</p>
        {% endif %}
      </div>
    </div>

    <div id="active-projects" class="content-section">
      <h3>Active Projects</h3>
      <p>Coming soon...</p>
    </div>

    <div id="favorite-projects" class="content-section">
      <h3>Favorite Projects</h3>
      <p>Coming soon...</p>
    </div>
  </div>
</div>

<!-- ===== Scripts ======================================================= -->
<script>
  // Toggle Skill Form
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("toggle-skill-form");
  const form = document.getElementById("skill-form");

  if (btn && form) {
    btn.addEventListener("click", () => {
      form.style.display = form.style.display === "none" || !form.style.display
        ? "block"
        : "none";
    });
  }
});

function toggleEditMode() {
  const accountDetails = document.getElementById('account-details');
  const infoEdit = document.getElementById('info-edit');

  if (infoEdit.style.display === 'none' || !infoEdit.style.display) {
    accountDetails.style.display = 'none';
    infoEdit.style.display = 'block';
  } else {
    accountDetails.style.display = 'block';
    infoEdit.style.display = 'none';
  }
}
</script>
{% endblock %}
